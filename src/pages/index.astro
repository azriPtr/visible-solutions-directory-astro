---
import HeroSection from "../components/HeroSection.astro";
import Layout from "../layouts/Layout.astro";
import AiSection from "../components/AiSection.astro";
import ContentSection from "../components/ContentSection.astro";
import ReviewSection from "../components/ReviewSection.astro";
import SubscribeSection from "../components/SubscribeSection.astro";
import VerifiedSection from "../components/VerifiedSection.astro";
import FAQ from "../components/FAQ.astro";

import { seo } from "../data/homepage";
import { getHomepageServices } from "../data/services/index";
import { getHomepageLocations } from "../data/locations";
import { getCollection } from "astro:content";

// Strapi Integration
import {
  getHomepage,
  isHeroSection,
  isCTASection,
  isCardsSection,
  isFAQSection,
} from "../lib/strapi";
import type {
  HeroSectionComponent,
  CTASectionComponent,
  CardsSectionComponent,
  FAQSectionComponent,
} from "../lib/strapi";

// ============================================================================
// STRAPI DATA FETCHING & EXTRACTION (All logic in frontmatter)
// ============================================================================

const homepage = await getHomepage();
const sections = homepage.data.content;

// Extract sections by type using type guards
const heroSection = sections.find(isHeroSection) as
  | HeroSectionComponent
  | undefined;
const ctaSections = sections.filter(isCTASection) as CTASectionComponent[];
const cardsSections = sections.filter(
  isCardsSection,
) as CardsSectionComponent[];
const faqSection = sections.find(isFAQSection) as
  | FAQSectionComponent
  | undefined;

// Map CTA sections by position (based on API order)
const aiSection = ctaSections[0]; // First CTA: AI Finder
const subscribeSection = ctaSections[1]; // Second CTA: Business signup

// Map Cards sections by content type
const servicesSection = cardsSections.find((s) => s.content === "service");
const locationsSection = cardsSections.find((s) => s.content === "location");
const articlesSection = cardsSections.find((s) => s.content === "article");

// ============================================================================
// LOCAL DATA LAYER (Items for cards)
// ============================================================================

// Services from data layer
const servicesData = getHomepageServices();
const services = servicesData.map((service) => ({
  variant: "service" as const,
  number: "",
  title: service.title,
  description: service.description,
  linkUrl: `/services/${service.slug}`,
  linkText: service.ctaText,
}));

// Locations from data layer
const locationsData = getHomepageLocations();
const locations = locationsData.map((location) => ({
  variant: "location" as const,
  ...location,
}));

// Articles from content collections
const articlesData = await getCollection("articles");
const articles = articlesData.map((entry) => ({
  variant: "article" as const,
  ...entry.data,
  image: entry.data.image.src,
}));

// SEO Data
const seoData = seo;
---

<Layout {...seoData}>
  {heroSection && <HeroSection data={heroSection} />}
  {aiSection && <AiSection data={aiSection} />}
  {
    servicesSection && (
      <ContentSection data={servicesSection} items={services} />
    )
  }
  <ReviewSection />
  {
    locationsSection && (
      <ContentSection data={locationsSection} items={locations} />
    )
  }
  {subscribeSection && <SubscribeSection data={subscribeSection} />}
  {
    articlesSection && (
      <ContentSection data={articlesSection} items={articles} />
    )
  }
  <VerifiedSection />
  {faqSection && <FAQ data={faqSection} />}
</Layout>
