---
import Layout from "../../../../layouts/Layout.astro";
import PageHero from "../../../../components/PageHero.astro";
import Button from "../../../../components/Button.astro";
import Card from "../../../../components/Card.astro";
import { getCollection } from "astro:content";
import { getAllCities, getCityInCounty, getCountyBySlug } from "../../../../data/locations/index";
import { serviceCategories, getAllServices } from "../../../../data/services/index";

// Generate static paths for all county/city combinations
export async function getStaticPaths() {
  const cities = getAllCities();
  return cities.map((city) => ({
    params: { county: city.countySlug, city: city.slug },
    props: { city },
  }));
}

// Get the city data
const { county: countySlug, city: citySlug } = Astro.params;
const cityData = getCityInCounty(countySlug, citySlug);
const countyData = getCountyBySlug(countySlug);

// 404 if city or county not found
if (!cityData || !countyData) {
  return Astro.redirect("/404");
}

// Get locksmiths that serve this city (from content collection)
const allLocksmiths = await getCollection("locksmiths");
const cityLocksmiths = allLocksmiths.filter((locksmith) => {
  const areas = locksmith.data.serviceAreas || [];
  return areas.some((area: string) => 
    area.toLowerCase().includes(cityData.name.toLowerCase()) ||
    cityData.name.toLowerCase().includes(area.toLowerCase())
  );
}).slice(0, 6); // Limit to 6 featured

// Get services for quick links
const services = getAllServices().slice(0, 4);

const seoData = {
  title: `Locksmiths in ${cityData.name}, ${countyData.name} | UK Locksmith Directory`,
  description: cityData.description,
};

// Breadcrumbs
const breadcrumbs = [
  { label: "Home", href: "/" },
  { label: "Locations", href: "/locations" },
  { label: countyData.name, href: `/locations/${countySlug}` },
  { label: cityData.name, href: `/locations/${countySlug}/${citySlug}` },
];

// Mock locksmiths if no real ones match
const displayLocksmiths = cityLocksmiths.length > 0 ? cityLocksmiths : [];
---

<Layout {...seoData}>
  <div class="bg-base-50">
    <div class="mx-auto max-w-7xl px-4 sm:px-6">
      <!-- Breadcrumbs -->
      <nav aria-label="Breadcrumb" class="py-4">
        <ol class="flex items-center gap-2 text-sm text-base-content/60">
          {
            breadcrumbs.map((crumb, index) => (
              <li class="flex items-center gap-2">
                {index < breadcrumbs.length - 1 ? (
                  <a href={crumb.href} class="hover:text-primary">
                    {crumb.label}
                  </a>
                ) : (
                  <span aria-current="page" class="text-base-content">
                    {crumb.label}
                  </span>
                )}
                {index < breadcrumbs.length - 1 && (
                  <span aria-hidden="true">/</span>
                )}
              </li>
            ))
          }
        </ol>
      </nav>

      <!-- Hero Section -->
      <PageHero
        title={`Locksmiths in ${cityData.name}`}
        description={cityData.description}>
        <!-- Stats -->
        <div class="mb-6 flex flex-wrap gap-6 text-sm">
          <div class="flex items-center gap-2">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="text-primary">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span class="font-semibold text-primary">{cityData.prosCount}</span>
          </div>
          {cityData.postcodes && (
            <div class="flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-primary">
                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <span class="text-base-content/70">{cityData.postcodes.length} postcode areas</span>
            </div>
          )}
        </div>

        <!-- CTA Buttons -->
        <div class="flex flex-wrap gap-4">
          <Button href={`/search?location=${citySlug}`} variant="primary" size="lg">
            Find locksmiths in {cityData.name}
          </Button>
          <Button href="/emergency" variant="outline" size="lg" iconLeft="icon-[tabler--phone]">
            Emergency help
          </Button>
        </div>
      </PageHero>

      <!-- Services in This City -->
      <section class="mb-16">
        <h2 class="mb-6 text-2xl font-bold text-primary">
          Locksmith Services in {cityData.name}
        </h2>

        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
          {
            services.map((service) => (
              <a
                href={`/locations/${countySlug}/${citySlug}/${service.slug}`}
                class="group rounded-lg border border-base-200 bg-white p-5 transition-all hover:border-primary hover:shadow-md">
                <div class="mb-3 flex items-center justify-between">
                  <span class={`rounded px-2 py-1 text-xs font-semibold uppercase ${
                    service.badge.color === "error" ? "bg-error/10 text-error" :
                    service.badge.color === "warning" ? "bg-warning/10 text-warning" :
                    service.badge.color === "success" ? "bg-success/10 text-success" :
                    "bg-primary/10 text-primary"
                  }`}>
                    {service.badge.text}
                  </span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-base-content/40 transition-transform group-hover:translate-x-1 group-hover:text-primary">
                    <path d="M5 12h14"></path>
                    <path d="m12 5 7 7-7 7"></path>
                  </svg>
                </div>
                <h3 class="mb-1 font-bold text-primary group-hover:underline">
                  {service.title}
                </h3>
                <p class="text-sm text-base-content/70 line-clamp-2">
                  {service.description}
                </p>
              </a>
            ))
          }
        </div>

        <div class="mt-6 text-center">
          <Button href="/services" variant="outline" size="md">
            View all services
          </Button>
        </div>
      </section>

      <!-- Featured Locksmiths -->
      {displayLocksmiths.length > 0 && (
        <section class="mb-16">
          <div class="mb-6 flex items-center justify-between">
            <h2 class="text-2xl font-bold text-primary">
              Featured Locksmiths in {cityData.name}
            </h2>
            <Button href={`/search?location=${citySlug}`} variant="text" size="sm">
              View all â†’
            </Button>
          </div>

          <ul class="space-y-4">
            {
              displayLocksmiths.map((locksmith) => (
                <Card
                  variant="listing"
                  title={locksmith.data.title}
                  description={locksmith.data.focus || "Professional locksmith services"}
                  rating={locksmith.data.rating}
                  reviewCount={locksmith.data.reviewCount}
                  badges={[
                    ...(locksmith.data.isVerified ? ["VERIFIED"] : []),
                    ...(locksmith.data.isEmergency ? ["24/7"] : []),
                    ...(locksmith.data.isDbsChecked ? ["DBS CHECKED"] : []),
                  ]}
                  features={[
                    ...(locksmith.data.isDbsChecked ? ["DBS Checked"] : []),
                    ...(locksmith.data.insurance ? [locksmith.data.insurance] : []),
                  ]}
                  phone={locksmith.data.phone}
                  profileUrl={`/locksmiths/${locksmith.slug}`}
                  isFeatured={true}
                />
              ))
            }
          </ul>
        </section>
      )}

      <!-- If no locksmiths, show search prompt -->
      {displayLocksmiths.length === 0 && (
        <section class="mb-16">
          <div class="rounded-lg border border-base-200 bg-white p-8 text-center">
            <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-primary/10">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-primary">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.3-4.3"></path>
              </svg>
            </div>
            <h2 class="mb-2 text-xl font-bold text-primary">
              Find Locksmiths in {cityData.name}
            </h2>
            <p class="mb-6 text-base-content/70">
              Search our directory to find verified locksmiths serving your area.
            </p>
            <Button href={`/search?location=${citySlug}`} variant="primary" size="lg">
              Search {cityData.name} locksmiths
            </Button>
          </div>
        </section>
      )}

      <!-- Postcode Coverage -->
      {cityData.postcodes && cityData.postcodes.length > 0 && (
        <section class="mb-16">
          <h2 class="mb-6 text-2xl font-bold text-primary">
            Postcode Coverage in {cityData.name}
          </h2>

          <div class="rounded-lg border border-base-200 bg-white p-6">
            <p class="mb-4 text-base-content/70">
              Our locksmiths serve the following postcode areas:
            </p>
            <div class="flex flex-wrap gap-2">
              {cityData.postcodes.map((postcode) => (
                <span class="rounded-md bg-base-100 px-3 py-1.5 text-sm font-medium text-base-content">
                  {postcode}
                </span>
              ))}
            </div>
          </div>
        </section>
      )}

      <!-- Back Navigation -->
      <section class="pb-16 text-center">
        <div class="flex flex-wrap justify-center gap-4">
          <Button
            href={`/locations/${countySlug}`}
            variant="outline"
            size="md"
            iconLeft="icon-[tabler--arrow-left]">
            Back to {countyData.name}
          </Button>
          <Button
            href="/locations"
            variant="text"
            size="md">
            All locations
          </Button>
        </div>
      </section>
    </div>
  </div>
</Layout>
