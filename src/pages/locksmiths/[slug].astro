---
import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Button from "../../components/Button.astro";
import CTASection from "../../components/CTASection.astro";
import {
  buildStrapiSrcSet,
  generateSizes,
  isExternalImage,
} from "../../lib/imageUtils";
import {
  buildLocksmithSchema,
  buildBreadcrumbSchema,
  renderSchema,
} from "../../lib/schema";

// Generate paths for all locksmiths
export async function getStaticPaths() {
  const locksmiths = await getCollection("locksmiths");
  return locksmiths.map((locksmith) => ({
    params: { slug: locksmith.slug },
    props: { locksmith },
  }));
}

// Retrieve the locksmith data
const { locksmith } = Astro.props;
const { Content } = await render(locksmith);

const seoData = {
  title: `${locksmith.data.title} | UK Locksmith Directory`,
  description: `${locksmith.data.title} - Rated ${locksmith.data.rating}/5 with ${locksmith.data.reviewCount} reviews. ${locksmith.data.focus || "Professional locksmith services"}`,
};

const stars = Array.from({ length: 5 }, (_, i) => i < locksmith.data.rating);

const locksmithSchema = buildLocksmithSchema(
  {
    title: locksmith.data.title,
    phone: locksmith.data.phone,
    rating: locksmith.data.rating,
    reviewCount: locksmith.data.reviewCount,
    serviceAreas: locksmith.data.serviceAreas,
    openingHours: locksmith.data.openingHours,
    insurance: locksmith.data.insurance,
  },
  locksmith.slug,
);

// Prepare optimized attributes for service area map if it's an external image
const serviceAreaMapUrl =
  typeof locksmith.data.serviceAreaMap === "string"
    ? locksmith.data.serviceAreaMap
    : locksmith.data.serviceAreaMap?.src;
const serviceAreaMapAttrs =
  serviceAreaMapUrl &&
  typeof serviceAreaMapUrl === "string" &&
  isExternalImage(serviceAreaMapUrl)
    ? {
        srcset: buildStrapiSrcSet(serviceAreaMapUrl),
        sizes: generateSizes({
          sm: "100vw",
          md: "100vw",
          lg: "66vw",
          default: "800px",
        }),
      }
    : {};

// Generate breadcrumbs
const pathname = Astro.url.pathname;
const segments = pathname.split("/").filter(Boolean);
const breadcrumbs = [{ label: "Home", href: "/" }];

let currentPath = "";
segments.forEach((segment, index) => {
  currentPath += `/${segment}`;
  const isLast = index === segments.length - 1;
  const label = segment
    .split("-")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
  breadcrumbs.push({
    label,
    href: isLast ? "" : currentPath,
  });
});

const breadcrumbSchema = buildBreadcrumbSchema(breadcrumbs);

const schemaScript = renderSchema([locksmithSchema, breadcrumbSchema]);
---

<Layout {...seoData}>
  <Fragment slot="head" set:html={schemaScript} />
  <div class="bg-base-100 py-8">
    <div class="container mx-auto max-w-7xl px-4">
      <!-- Breadcrumbs - Semantic Navigation -->
      <nav aria-label="Breadcrumb" class="mb-6">
        <ol class="flex items-center gap-2 text-sm text-base-content/60">
          {
            breadcrumbs.map((crumb, index) => (
              <li class="flex items-center gap-2">
                {crumb.href ? (
                  <a href={crumb.href} class="hover:text-primary">
                    {crumb.label}
                  </a>
                ) : (
                  <span aria-current="page" class="text-base-content">
                    {crumb.label}
                  </span>
                )}
                {index < breadcrumbs.length - 1 && (
                  <span aria-hidden="true">/</span>
                )}
              </li>
            ))
          }
        </ol>
      </nav>

      <div class="grid gap-8 lg:grid-cols-3">
        <!-- Main Content - Article Element -->
        <article class="lg:col-span-2">
          <!-- Article Header -->
          <header class="mb-8">
            <h1 class="mb-4 text-4xl font-bold text-primary">
              {locksmith.data.title}
            </h1>

            <div class="mb-4 flex flex-wrap items-center gap-4">
              <!-- Star Rating -->
              <div class="flex items-center gap-2">
                <div class="flex items-center gap-0.5">
                  {
                    stars.map((isFilled) => (
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill={isFilled ? "currentColor" : "none"}
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class={isFilled ? "text-secondary" : "text-base-300"}>
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                      </svg>
                    ))
                  }
                </div>
                <span class="text-lg font-bold text-base-content">
                  {locksmith.data.rating}/5
                </span>
                <span class="text-base-content/60">
                  {locksmith.data.reviewCount} Directory Reviews
                </span>
              </div>

              <!-- Google Rating -->
              {
                locksmith.data.googleRating && (
                  <>
                    <span class="text-base-content/40" aria-hidden="true">
                      |
                    </span>
                    <div class="flex items-center gap-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                        class="text-[#4285F4]"
                        aria-label="Google">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                      </svg>
                      <span class="text-sm text-base-content/70">
                        Rated {locksmith.data.googleRating} on Google
                      </span>
                    </div>
                  </>
                )
              }
            </div>

            <!-- Badges -->
            <div class="mb-4 flex flex-wrap gap-3">
              {
                locksmith.data.isVerified && (
                  <span class="flex items-center gap-2 rounded-md bg-success/10 px-3 py-1.5 text-sm font-semibold text-success">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      aria-hidden="true">
                      <path d="M20 6 9 17l-5-5" />
                    </svg>
                    Directory Verified
                  </span>
                )
              }
              {
                locksmith.data.isDbsChecked && (
                  <span class="flex items-center gap-2 rounded-md bg-primary/10 px-3 py-1.5 text-sm font-semibold text-primary">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      aria-hidden="true">
                      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />
                    </svg>
                    DBS Checked
                  </span>
                )
              }
              {
                locksmith.data.isEmergency && (
                  <span class="flex items-center gap-2 rounded-md bg-error/10 px-3 py-1.5 text-sm font-semibold text-error">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      aria-hidden="true">
                      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                    </svg>
                    24/7 Emergency
                  </span>
                )
              }
            </div>
          </header>

          <!-- At a Glance Section -->
          <section
            aria-labelledby="glance-heading"
            class="mb-12 rounded-lg border border-base-200 bg-white p-6">
            <h2 id="glance-heading" class="mb-4 text-xl font-bold text-primary">
              At a Glance
            </h2>
            <div class="grid gap-4 sm:grid-cols-2">
              {
                locksmith.data.established && (
                  <div class="flex items-start gap-3">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="mt-0.5 flex-shrink-0 text-base-content/40"
                      aria-hidden="true">
                      <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                      <line x1="16" x2="16" y1="2" y2="6" />
                      <line x1="8" x2="8" y1="2" y2="6" />
                      <line x1="3" x2="21" y1="10" y2="10" />
                    </svg>
                    <div>
                      <div class="text-sm text-base-content/70">
                        Est. {locksmith.data.established}
                      </div>
                    </div>
                  </div>
                )
              }
              {
                locksmith.data.focus && (
                  <div class="flex items-start gap-3">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="mt-0.5 flex-shrink-0 text-base-content/40"
                      aria-hidden="true">
                      <circle cx="11" cy="11" r="8" />
                      <path d="m21 21-4.3-4.3" />
                    </svg>
                    <div>
                      <div class="text-sm text-base-content/70">
                        Focus: {locksmith.data.focus}
                      </div>
                    </div>
                  </div>
                )
              }
              {
                locksmith.data.insurance && (
                  <div class="flex items-start gap-3">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="mt-0.5 flex-shrink-0 text-base-content/40"
                      aria-hidden="true">
                      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />
                    </svg>
                    <div>
                      <div class="text-sm text-base-content/70">
                        {locksmith.data.insurance}
                      </div>
                    </div>
                  </div>
                )
              }
              {
                locksmith.data.callOutFee && (
                  <div class="flex items-start gap-3">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="mt-0.5 flex-shrink-0 text-base-content/40"
                      aria-hidden="true">
                      <line x1="12" x2="12" y1="2" y2="22" />
                      <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                    </svg>
                    <div>
                      <div class="text-sm text-base-content/70">
                        {locksmith.data.callOutFee}
                      </div>
                    </div>
                  </div>
                )
              }
            </div>
          </section>

          <!-- About Section -->
          <section aria-labelledby="about-heading" class="mb-12">
            <h2 id="about-heading" class="mb-4 text-2xl font-bold text-primary">
              About {locksmith.data.title}
            </h2>
            <div class="prose prose-lg max-w-none text-base-content/80">
              <Content />
            </div>
          </section>

          <!-- Services Offered Section -->
          {
            locksmith.data.servicesOffered &&
              locksmith.data.servicesOffered.length > 0 && (
                <section aria-labelledby="services-heading" class="mb-12">
                  <h2
                    id="services-heading"
                    class="mb-6 text-2xl font-bold text-primary">
                    Services Offered
                  </h2>
                  <div class="grid gap-6 sm:grid-cols-2">
                    {locksmith.data.servicesOffered.map((service) => (
                      <div class="flex gap-4 rounded-lg border border-base-200 bg-white p-6 transition-shadow hover:shadow-md">
                        <div class="flex-shrink-0">
                          <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-primary/10 text-primary">
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="24"
                              height="24"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              set:html={service.icon}
                              aria-hidden="true"
                            />
                          </div>
                        </div>
                        <div>
                          <h3 class="mb-1 font-bold text-primary">
                            {service.title}
                          </h3>
                          <p class="text-sm text-base-content/70">
                            {service.description}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                </section>
              )
          }

          <!-- Service Area Section -->
          {
            locksmith.data.serviceAreas &&
              locksmith.data.serviceAreas.length > 0 && (
                <section aria-labelledby="service-area-heading" class="mb-12">
                  <div class="mb-4 flex items-center justify-between">
                    <h2
                      id="service-area-heading"
                      class="text-2xl font-bold text-primary">
                      Service Area
                    </h2>
                    {locksmith.data.serviceAreaRadius && (
                      <span class="text-sm text-base-content/60">
                        Within {locksmith.data.serviceAreaRadius}
                      </span>
                    )}
                  </div>

                  {locksmith.data.serviceAreaMap && (
                    <div class="mb-6 overflow-hidden rounded-lg">
                      <img
                        src={serviceAreaMapUrl}
                        {...serviceAreaMapAttrs}
                        alt={
                          locksmith.data.serviceAreaMapAlt || "Service Area Map"
                        }
                        class="h-64 w-full object-cover"
                        loading="lazy"
                        decoding="async"
                        width="800"
                        height="256"
                      />
                    </div>
                  )}

                  <div class="flex flex-wrap gap-2">
                    {locksmith.data.serviceAreas.map((area) => (
                      <span class="rounded-md bg-base-100 px-3 py-1.5 text-sm font-medium text-base-content">
                        {area}
                      </span>
                    ))}
                  </div>
                </section>
              )
          }

          <!-- Directory Reviews Section -->
          {
            locksmith.data.directoryReviews &&
              locksmith.data.directoryReviews.length > 0 && (
                <section aria-labelledby="reviews-heading" class="mb-12">
                  <div class="mb-6 flex items-center justify-between">
                    <h2
                      id="reviews-heading"
                      class="text-2xl font-bold text-primary">
                      Directory Reviews
                    </h2>
                    <span class="text-sm text-base-content/60">
                      Verified customers from UK Locksmith Directory
                    </span>
                  </div>

                  <ul class="space-y-6">
                    {locksmith.data.directoryReviews
                      .slice(0, 2)
                      .map((review) => (
                        <li>
                          <article class="rounded-lg border border-base-200 bg-white p-6">
                            <header class="mb-4 flex items-start gap-4">
                              <div class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-primary/10 font-bold text-primary">
                                {review.initials}
                              </div>
                              <div class="flex-1">
                                <div class="mb-1 font-bold text-base-content">
                                  {review.author}
                                </div>
                                <time class="text-sm text-base-content/60">
                                  {review.date}
                                </time>
                              </div>
                            </header>
                            <p class="mb-3 text-base-content/80">
                              {review.comment}
                            </p>
                            {review.isVerified && (
                              <div class="flex items-center gap-2 text-sm text-success">
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="14"
                                  height="14"
                                  viewBox="0 0 24 24"
                                  fill="none"
                                  stroke="currentColor"
                                  stroke-width="2"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  aria-hidden="true">
                                  <path d="M20 6 9 17l-5-5" />
                                </svg>
                                Verified Customer
                              </div>
                            )}
                          </article>
                        </li>
                      ))}
                  </ul>

                  {locksmith.data.directoryReviews.length > 2 && (
                    <div class="mt-6 text-center">
                      <button class="text-sm font-semibold text-primary hover:underline">
                        View all {locksmith.data.reviewCount} directory reviews
                        â†’
                      </button>
                    </div>
                  )}
                </section>
              )
          }

          <!-- External Reviews Section -->
          {
            locksmith.data.externalReviews &&
              locksmith.data.externalReviews.length > 0 && (
                <section
                  aria-labelledby="external-reviews-heading"
                  class="mb-12">
                  <h3
                    id="external-reviews-heading"
                    class="mb-4 text-lg font-bold text-primary">
                    External reviews from around the web
                  </h3>
                  <div class="grid gap-4 sm:grid-cols-2">
                    {locksmith.data.externalReviews.map((review) => (
                      <div class="rounded-lg border border-base-200 bg-white p-6">
                        <div class="mb-2 flex items-center gap-3">
                          {review.platform === "Google" && (
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="24"
                              height="24"
                              viewBox="0 0 24 24"
                              fill="currentColor"
                              class="text-[#4285F4]"
                              aria-label="Google">
                              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                            </svg>
                          )}
                          {review.platform === "Trustpilot" && (
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="24"
                              height="24"
                              viewBox="0 0 24 24"
                              fill="currentColor"
                              class="text-[#00B67A]"
                              aria-label="Trustpilot">
                              <path d="M12 2l3.1 6.3 6.9 1-5 4.9 1.2 6.8L12 18l-6.2 3.3 1.2-6.8-5-4.9 6.9-1z" />
                            </svg>
                          )}
                          <div>
                            <div class="text-xl font-bold text-base-content">
                              {review.rating} / 5.0
                            </div>
                            <div class="text-sm text-base-content/60">
                              Based on {review.reviewCount} reviews
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <p class="mt-4 text-xs text-base-content/50">
                    *External ratings are not collected by this directory and/or
                    its operators
                  </p>
                </section>
              )
          }
        </article>

        <!-- Sidebar - Aside Element -->
        <aside
          aria-label="Contact information and business hours"
          class="lg:col-span-1">
          <div class="sticky top-4 space-y-6">
            <!-- Contact Provider Card -->
            <section
              aria-labelledby="contact-heading"
              class="rounded-lg border border-base-200 bg-white p-6 shadow-sm">
              <h2
                id="contact-heading"
                class="mb-2 text-xl font-bold text-primary">
                Contact Provider
              </h2>
              {
                locksmith.data.responseTime && (
                  <p class="mb-4 text-sm text-base-content/60">
                    Response time avg. {locksmith.data.responseTime}
                  </p>
                )
              }

              <address class="not-italic">
                <Button
                  href={`tel:${locksmith.data.phone}`}
                  variant="primary"
                  size="lg"
                  class="mb-3 w-full"
                  iconLeft="icon-[tabler--phone]">
                  {locksmith.data.phone}
                </Button>
              </address>

              <Button
                href="#contact"
                variant="outline"
                size="lg"
                class="w-full">
                Request Quote
              </Button>

              <hr class="my-6 border-base-200" />

              <!-- Status -->
              <div class="mb-4">
                <div class="mb-2 text-sm font-semibold text-base-content/70">
                  Status
                </div>
                <div class="flex items-center gap-2">
                  <span
                    class={`h-2 w-2 rounded-full ${
                      locksmith.data.status === "Open Now"
                        ? "bg-success"
                        : locksmith.data.status === "24 Hours"
                          ? "bg-primary"
                          : "bg-base-300"
                    }`}
                    aria-hidden="true"></span>
                  <span class="font-semibold text-base-content">
                    {locksmith.data.status}
                  </span>
                </div>
              </div>

              <!-- Opening Hours -->
              {
                locksmith.data.openingHours &&
                  locksmith.data.openingHours.length > 0 && (
                    <div class="space-y-2 text-sm">
                      {locksmith.data.openingHours.map((schedule) => (
                        <div class="flex justify-between">
                          <span class="text-base-content/70">
                            {schedule.day}
                          </span>
                          <span class="font-medium text-base-content">
                            {schedule.hours}
                          </span>
                        </div>
                      ))}
                    </div>
                  )
              }

              <hr class="my-6 border-base-200" />

              <!-- Verification Checks -->
              <div class="space-y-3">
                {
                  locksmith.data.isIdentityVerified && (
                    <div class="flex items-center gap-2 text-sm">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="text-success"
                        aria-hidden="true">
                        <path d="M20 6 9 17l-5-5" />
                      </svg>
                      <span class="text-base-content/80">
                        Identity Verified
                      </span>
                    </div>
                  )
                }
                {
                  locksmith.data.isInsuranceChecked && (
                    <div class="flex items-center gap-2 text-sm">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="text-success"
                        aria-hidden="true">
                        <path d="M20 6 9 17l-5-5" />
                      </svg>
                      <span class="text-base-content/80">
                        Insurance Checked
                      </span>
                    </div>
                  )
                }
              </div>
            </section>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <CTASection
    title="Find uPVC Specialists near you"
    description="Connect with vetted locksmiths who specialize in multipoint lock adjustment, gearbox replacement, and door alignment in your local area."
    buttonText="Search for uPVC specialists"
    buttonHref="/search"
  />
</Layout>
